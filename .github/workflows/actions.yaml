name: Deploy MkDocs Site

on:
  push:
    branches:
      - main  # или другая основная ветка
  # workflow_dispatch:  # ручная активация через интерфейс GitHub

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Checkout репозитория
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Настройка Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      # 3. Установка зависимостей
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      # 4. Сборка сайта из папки site/, вывод в docs/
      - name: Build MkDocs site
        run: |
          mkdocs build -f source/mkdocs.yml --site-dir ../docs --clean

      # 5. Деплой: коммит в текущую ветку (изменения в docs/)
      - name: Force-add docs/ (bypass .gitignore for tracked files)
        run: |
          # Critical: Use -f to force-add even if .gitignore blocks docs/
          git add -f docs/
          echo "=== Git status AFTER add ==="
          git status --short

      - name: Commit and push ONLY if changes exist
        run: |
          if git diff --cached --quiet; then
            echo "❌ CRITICAL: Build completed but NO CHANGES detected in docs/!"
            echo "   Possible causes:"
            echo "   1. Root .gitignore is blocking docs/ (check workflow logs above)"
            echo "   2. Theme/plugin not installed (check 'Install MkDocs + Theme' step)"
            echo "   3. mkdocs.yml changes didn't affect output (verify theme name spelling)"
            echo "   4. Build used cached files (unlikely with --clean)"
            exit 1  # FAIL workflow to alert you
          fi
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Deploy MkDocs site - $(date +%Y%m%d-%H%M%S) [skip ci]"
          git push